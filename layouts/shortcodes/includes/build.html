{{- $armorParts := slice "head" "shoulders" "coat" "gloves" "leggings" "boots" -}}
{{- $armorRuneCounts := dict -}}

{{- $build := .Page.Params.build -}}

{{- $consumables := $build.consumables -}}
{{- $equipments := $build.equipments -}}
{{- $template := $build.template -}}

{{- $chatcode := slice "build" $template | partial "functions/gw2-chat-link.string" -}}

{{- range $armorParts -}}
    {{- $armorItem := . | index $equipments -}}
    {{- $armorRuneItem := "rune" | index $armorItem -}}
    {{- with "id" | index $armorRuneItem | string -}}
        {{- $armorRuneCounts = . | index $armorRuneCounts | default 0 | add 1 | dict . | merge $armorRuneCounts -}}
    {{- end -}}
{{- end -}}

{{- define "__rfgames_shortcode_includes__build_embed__" -}}
    {{- $type := 0 | index . -}}
    {{- $classes := 1 | index . -}}
    {{- $item := 2 | index . -}}
    {{- $upgrade := 3 | index . -}}
    {{- $showText := 4 | index . | default true -}}

    <div class="build-card-embed {{ delimit $classes " " }}">
        {{- with $item -}}
            {{- $data := $item -}}
            {{- $data = true | dict "disable-text" | merge $data -}}

            {{- if "id" | index $data | gt 0 -}}
                {{- $data = true | dict "disable-tooltip" | merge $data -}}
            {{- end -}}

            {{- slice "build-card-icon" | slice $type false $data | partial "elements/embed.html" -}}
        {{- end -}}

        {{- if $showText -}}
            {{- with $item -}}
                {{- $data := $item -}}
                {{- $data = true | dict "disable-icon" | merge $data -}}

                {{- if "id" | index $data | gt 0 -}}
                    {{- $data = true | dict "disable-text" | merge $data -}}
                {{- end -}}

                {{- slice "build-card-text" | slice $type false $data | partial "elements/embed.html" -}}
            {{- end -}}
        {{- end -}}

        {{- with $upgrade -}}
            {{- $classes := slice "build-card-upgrade" -}}
            {{- template "__rfgames_shortcode_includes__build_embed__" slice $type $classes . -}}
        {{- end -}}
    </div>
{{- end -}}

{{- define "__rfgames_shortcode_includes__build_equipment_armor__" -}}
    {{- $classes := 0 | index . | printf "is-%s" | slice "is-armor" -}}
    {{- $armorRuneCounts := 2 | index . -}}

    {{- with 1 | index . -}}
        {{- $id := "id" | index . -}}
        {{- $name := "name" | index . -}}
        {{- $stat := "stat" | index . | default -1 -}}
        {{- $infusion := "infusion" | index . -}}
        {{- $rune := "rune" | index . -}}
        {{- $upgradeCount := 0 -}}

        {{- $runeId := "id" | index $rune -}}
        {{- $runeName := "name" | index $rune -}}

        {{- with $runeId -}}
            {{- $upgradeCount = . | string | index $armorRuneCounts -}}
        {{- end -}}

        {{- $item := dict -}}
        {{- $item = $id | dict "id" | merge $item -}}
        {{- $item = $name | dict "text" | merge $item -}}
        {{- $item = $stat | dict "stat" | merge $item -}}
        {{- $item = $infusion | dict "infusions" | merge $item -}}
        {{- $item = $runeId | dict "upgrades" | merge $item -}}
        {{- $item = $upgradeCount | dict "upgrade-count" | merge $item -}}

        {{- $upgrade := dict -}}
        {{- $upgrade = $runeId | dict "id" | merge $upgrade -}}
        {{- $upgrade = $runeName | dict "text" | merge $upgrade -}}
        {{- $upgrade = $upgradeCount | dict "upgrade-count" | merge $upgrade -}}

        {{- template "__rfgames_shortcode_includes__build_embed__" slice "item" $classes $item $upgrade -}}
    {{- end -}}
{{- end -}}

{{- define "__rfgames_shortcode_includes__build_equipment_weapon__" -}}
    {{- $classes := 0 | index . | printf "is-%s" | slice "is-weapon" -}}

    {{- $block := "TEST" -}}

    {{- with 1 | index . -}}
        {{- $type := "type" | index . -}}

        {{- $weapon := "weapon" | index . -}}
        {{- $weapon1 := "weapon1" | index . -}}
        {{- $weapon2 := "weapon2" | index . -}}
        {{- $sigil1 := "sigil1" | index . -}}
        {{- $sigil2 := "sigil2" | index . -}}
        {{- $infusion1 := "infusion1" | index . -}}
        {{- $infusion2 := "infusion2" | index . -}}

        {{- if $type | eq "DualWield" -}}
            {{- with $weapon1 -}}
                {{- $id := "id" | index . -}}
                {{- $name := "name" | index . -}}
                {{- $stat := "stat" | index . | default -1 -}}

                {{- $sigilId := "id" | index $sigil1 -}}
                {{- $sigilName := "name" | index $sigil1 -}}

                {{- $upgrade := dict -}}
                {{- $upgrade = $sigilId | dict "id" | merge $upgrade -}}
                {{- $upgrade = $sigilName | dict "text" | merge $upgrade -}}

                {{- $item := dict -}}
                {{- $item = $id | dict "id" | merge $item -}}
                {{- $item = $name | dict "text" | merge $item -}}
                {{- $item = $stat | dict "stat" | merge $item -}}
                {{- $item = $infusion1 | dict "infusions" | merge $item -}}
                {{- $item = $sigilId | dict "upgrades" | merge $item -}}

                {{- $classes = $classes | append "is-dual-wield" -}}
                {{- $classes = $classes | append "is-main-hand-slot" -}}

                {{- template "__rfgames_shortcode_includes__build_embed__" slice "item" $classes $item $upgrade -}}
            {{- end -}}

            {{- with $weapon2 -}}
                {{- $id := "id" | index . -}}
                {{- $name := "name" | index . -}}
                {{- $stat := "stat" | index . | default -1 -}}

                {{- $sigilId := "id" | index $sigil2 -}}
                {{- $sigilName := "name" | index $sigil2 -}}

                {{- $upgrade := dict -}}
                {{- $upgrade = $sigilId | dict "id" | merge $upgrade -}}
                {{- $upgrade = $sigilName | dict "text" | merge $upgrade -}}

                {{- $item := dict -}}
                {{- $item = $id | dict "id" | merge $item -}}
                {{- $item = $name | dict "text" | merge $item -}}
                {{- $item = $stat | dict "stat" | merge $item -}}
                {{- $item = $infusion2 | dict "infusions" | merge $item -}}
                {{- $item = $sigilId | dict "upgrades" | merge $item -}}

                {{- $classes = $classes | append "is-dual-wield" -}}
                {{- $classes = $classes | append "is-off-hand-slot" -}}

                {{- template "__rfgames_shortcode_includes__build_embed__" slice "item" $classes $item $upgrade -}}
            {{- end -}}
        {{- end -}}
        {{- if $type | eq "MainHandOnly" -}}
            {{- with $weapon1 -}}
                {{- $id := "id" | index . -}}
                {{- $name := "name" | index . -}}
                {{- $stat := "stat" | index . | default -1 -}}

                {{- $sigilId := "id" | index $sigil1 -}}
                {{- $sigilName := "name" | index $sigil1 -}}

                {{- $upgrade := dict -}}
                {{- $upgrade = $sigilId | dict "id" | merge $upgrade -}}
                {{- $upgrade = $sigilName | dict "text" | merge $upgrade -}}

                {{- $item := dict -}}
                {{- $item = $id | dict "id" | merge $item -}}
                {{- $item = $name | dict "text" | merge $item -}}
                {{- $item = $stat | dict "stat" | merge $item -}}
                {{- $item = $infusion1 | dict "infusions" | merge $item -}}
                {{- $item = $sigilId | dict "upgrades" | merge $item -}}

                {{- $classes = $classes | append "is-main-hand-only" -}}
                {{- $classes = $classes | append "is-main-hand-slot" -}}

                {{- template "__rfgames_shortcode_includes__build_embed__" slice "item" $classes $item $upgrade -}}
            {{- end -}}

            {{- with . -}}
                {{- $item := dict "id" -1 -}}

                {{- $classes = $classes | append "is-main-hand-only" -}}
                {{- $classes = $classes | append "is-off-hand-slot" -}}

                {{- template "__rfgames_shortcode_includes__build_embed__" slice "item" $classes $item -}}
            {{- end -}}
        {{- end -}}
        {{- if $type | eq "OffHandOnly" -}}
            {{- with . -}}
                {{- $item := dict "id" -1 -}}

                {{- $classes = $classes | append "is-off-hand-only" -}}
                {{- $classes = $classes | append "is-main-hand-slot" -}}

                {{- template "__rfgames_shortcode_includes__build_embed__" slice "item" $classes $item -}}
            {{- end -}}

            {{- with $weapon2 -}}
                {{- $id := "id" | index . -}}
                {{- $name := "name" | index . -}}
                {{- $stat := "stat" | index . | default -1 -}}

                {{- $sigilId := "id" | index $sigil2 -}}
                {{- $sigilName := "name" | index $sigil2 -}}

                {{- $upgrade := dict -}}
                {{- $upgrade = $sigilId | dict "id" | merge $upgrade -}}
                {{- $upgrade = $sigilName | dict "text" | merge $upgrade -}}

                {{- $item := dict -}}
                {{- $item = $id | dict "id" | merge $item -}}
                {{- $item = $name | dict "text" | merge $item -}}
                {{- $item = $stat | dict "stat" | merge $item -}}
                {{- $item = $infusion2 | dict "infusions" | merge $item -}}
                {{- $item = $sigilId | dict "upgrades" | merge $item -}}

                {{- $classes = $classes | append "is-off-hand-only" -}}
                {{- $classes = $classes | append "is-off-hand-slot" -}}

                {{- template "__rfgames_shortcode_includes__build_embed__" slice "item" $classes $item $upgrade -}}
            {{- end -}}
        {{- end -}}
        {{- if $type | eq "TwoHand" -}}
            {{- with $weapon -}}
                {{- $id := "id" | index . -}}
                {{- $name := "name" | index . -}}
                {{- $stat := "stat" | index . | default -1 -}}

                {{- $sigilId := "id" | index $sigil1 -}}
                {{- $sigilName := "name" | index $sigil1 -}}

                {{- $upgrade := dict -}}
                {{- $upgrade = $sigilId | dict "id" | merge $upgrade -}}
                {{- $upgrade = $sigilName | dict "text" | merge $upgrade -}}

                {{- $sigils := "id" | index $sigil2 | slice $sigilId -}}
                {{- $infusions := slice $infusion1 $infusion2 -}}

                {{- $item := dict -}}
                {{- $item = $id | dict "id" | merge $item -}}
                {{- $item = $name | dict "text" | merge $item -}}
                {{- $item = $stat | dict "stat" | merge $item -}}
                {{- $item = delimit $infusions "," | dict "infusions" | merge $item -}}
                {{- $item = delimit $sigils "," | dict "upgrades" | merge $item -}}

                {{- $classes = $classes | append "is-two-hand" -}}
                {{- $classes = $classes | append "is-main-hand-slot" -}}

                {{- template "__rfgames_shortcode_includes__build_embed__" slice "item" $classes $item $upgrade -}}
            {{- end -}}

            {{- with . -}}
                {{- $sigilId := "id" | index $sigil2 -}}
                {{- $sigilName := "name" | index $sigil2 -}}

                {{- $upgrade := dict -}}
                {{- $upgrade = $sigilId | dict "id" | merge $upgrade -}}
                {{- $upgrade = $sigilName | dict "text" | merge $upgrade -}}

                {{- $sigils := "id" | index $sigil1 | slice $sigilId -}}
                {{- $infusions := slice $infusion1 $infusion2 -}}

                {{- $item := dict -}}
                {{- $item = -1 | dict "id" | merge $item -}}
                {{- $item = delimit $infusions "," | dict "infusions" | merge $item -}}
                {{- $item = delimit $sigils "," | dict "upgrades" | merge $item -}}

                {{- $classes = $classes | append "is-two-hand" -}}
                {{- $classes = $classes | append "is-off-hand-slot" -}}

                {{- template "__rfgames_shortcode_includes__build_embed__" slice "item" $classes $item $upgrade -}}
            {{- end -}}
        {{- end -}}
    {{- end -}}
{{- end -}}

{{- define "__rfgames_shortcode_includes__build_equipment_trinket__" -}}
    {{- $classes := 0 | index . | printf "is-%s" | slice "is-trinket" -}}

    {{- with 1 | index . -}}
        {{- $id := "id" | index . -}}
        {{- $name := "name" | index . -}}
        {{- $stat := "stat" | index . | default -1 -}}
        {{- $infusion := "infusion" | index . -}}
        {{- $infusions := "infusions" | index . | default slice -}}
        {{- $upgrade := "upgrade" | index . -}}
        {{- $upgrades := "upgrades" | index . | default slice -}}

        {{- with $infusion -}}
            {{- $infusions = $infusions | append . -}}
        {{- end -}}

        {{- with $upgrade -}}
            {{- $upgrades = $upgrades | append . -}}
        {{- end -}}

        {{- $item := dict -}}
        {{- $item = $id | dict "id" | merge $item -}}
        {{- $item = $name | dict "text" | merge $item -}}
        {{- $item = $stat | dict "stat" | merge $item -}}
        {{- $item = delimit $infusions "," | dict "infusions" | merge $item -}}
        {{- $item = delimit $upgrades "," | dict "upgrades" | merge $item -}}

        {{- template "__rfgames_shortcode_includes__build_embed__" slice "item" $classes $item -}}
    {{- end -}}
{{- end -}}

{{- define "__rfgames_shortcode_includes__build_consumable__" -}}
    {{- $classes := 0 | index . | printf "is-%s" | slice "is-consumable" -}}

    {{- with 1 | index . -}}
        {{- $id := "id" | index . -}}
        {{- $name := "name" | index . -}}

        {{- $item := dict -}}
        {{- $item = $id | dict "id" | merge $item -}}
        {{- $item = $name | dict "text" | merge $item -}}

        {{- template "__rfgames_shortcode_includes__build_embed__" slice "item" $classes $item -}}
    {{- end -}}
{{- end -}}

{{- define "__rfgames_shortcode_includes__build_skill__" -}}
    {{- $classes := 0 | index . | printf "is-%s" | slice "is-skill" -}}
    {{- $showText := 2 | index . | default true -}}

    {{- with 1 | index . -}}
        {{- $skill := dict -}}
        {{- $skill = . | dict "id" | merge $skill -}}

        {{- template "__rfgames_shortcode_includes__build_embed__" slice "skill" $classes $skill false $showText -}}
    {{- end -}}
{{- end -}}

{{- define "__rfgames_shortcode_includes__build_traitline__" -}}
    {{- $id := 0 | index . -}}
    {{- $traits := . | after 1 -}}

    {{- $data := dict -}}
    {{- $data = $id | dict "id" | merge $data -}}
    {{- $data = delimit $traits "," | dict "traits" | merge $data -}}

    {{- slice "traitline" false $data | partial "elements/embed.html" -}}
{{- end -}}

<div class="build-card is-template">
    <div class="build-card-content">
        <span class="template-addon">Template</span>
        <span class="template-code" data-auto-selection>{{ $chatcode }}</span>
        <button
            class="template-copy"
            data-clipboard-text="{{ $chatcode }}"
            data-clipboard-message="Copied {{ .Page.Title }} template code to clipboard"
        >Copy</button>
    </div>
</div>

<div class="build-card is-armors">
    <h5 class="title">Armors</h5>
    <div class="build-card-content">
        {{ template "__rfgames_shortcode_includes__build_equipment_armor__" slice "head" $equipments.head $armorRuneCounts }}
        {{ template "__rfgames_shortcode_includes__build_equipment_armor__" slice "shoulders" $equipments.shoulders $armorRuneCounts }}
        {{ template "__rfgames_shortcode_includes__build_equipment_armor__" slice "coat" $equipments.coat $armorRuneCounts }}
        {{ template "__rfgames_shortcode_includes__build_equipment_armor__" slice "gloves" $equipments.gloves $armorRuneCounts }}
        {{ template "__rfgames_shortcode_includes__build_equipment_armor__" slice "leggings" $equipments.leggings $armorRuneCounts }}
        {{ template "__rfgames_shortcode_includes__build_equipment_armor__" slice "boots" $equipments.boots $armorRuneCounts }}
    </div>
</div>

<div class="build-card is-weapons">
    <h5 class="title">Weapons</h5>
    <div class="build-card-content">
        {{ template "__rfgames_shortcode_includes__build_equipment_weapon__" slice "weapon1" $equipments.weapon1 }}
        <div class="gw2-embed-container">
            {{- range $equipments.weapon1.skills -}}
                {{- template "__rfgames_shortcode_includes__build_skill__" slice "weapon-skill" . false -}}
            {{- end -}}
        </div>
        {{ template "__rfgames_shortcode_includes__build_equipment_weapon__" slice "weapon2" $equipments.weapon2 }}
        <div class="gw2-embed-container">
            {{- range $equipments.weapon2.skills -}}
                {{- template "__rfgames_shortcode_includes__build_skill__" slice "weapon-skill" . false -}}
            {{- end -}}
        </div>
    </div>
</div>

<div class="build-card is-trinkets">
    <h5 class="title">Trinkets</h5>
    <div class="build-card-content">
        {{ template "__rfgames_shortcode_includes__build_equipment_trinket__" slice "back" $equipments.back }}
        {{ template "__rfgames_shortcode_includes__build_equipment_trinket__" slice "accessory1" $equipments.accessory1 }}
        {{ template "__rfgames_shortcode_includes__build_equipment_trinket__" slice "accessory2" $equipments.accessory2 }}
        {{ template "__rfgames_shortcode_includes__build_equipment_trinket__" slice "amulet" $equipments.amulet }}
        {{ template "__rfgames_shortcode_includes__build_equipment_trinket__" slice "ring1" $equipments.ring1 }}
        {{ template "__rfgames_shortcode_includes__build_equipment_trinket__" slice "ring2" $equipments.ring2 }}
    </div>
</div>

<div class="build-card is-consumables">
    <h5 class="title">Consumables</h5>
    <div class="build-card-content">
        {{ template "__rfgames_shortcode_includes__build_consumable__" slice "food" $consumables.food }}
        {{ template "__rfgames_shortcode_includes__build_consumable__" slice "utility" $consumables.utility }}
    </div>
</div>

<div class="build-card is-skills">
    <h5 class="title">Skills</h5>
    <div class="build-card-content">
        <div class="gw2-embed-container">
            {{- range $template.skills | first 1 -}}
                {{- range . | first 1 -}}
                    {{- template "__rfgames_shortcode_includes__build_skill__" slice "healing" . -}}
                {{- end -}}
            {{- end -}}
            {{- range $template.skills | after 1 | first 3 -}}
                {{- range . | first 1 -}}
                    {{- template "__rfgames_shortcode_includes__build_skill__" slice "utility" . -}}
                {{- end -}}
            {{- end -}}
            {{- range $template.skills | after 4 -}}
                {{- range . | first 1 -}}
                    {{- template "__rfgames_shortcode_includes__build_skill__" slice "elite" . -}}
                {{- end -}}
            {{- end -}}
        </div>
    </div>
</div>

<div class="build-card is-specializations">
    <h5 class="title">Specializations</h5>
    <div class="build-card-content">
        {{- range $template.traits -}}
            {{- template "__rfgames_shortcode_includes__build_traitline__" . -}}
        {{- end -}}
    </div>
</div>
