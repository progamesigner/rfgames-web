{{- $context := 0 | index . -}}
{{- $accessToken := 1 | index . -}}

{{- $worlds := slice -}}

{{- if $accessToken | ne "" -}}
    {{- $accountData := slice $context $accessToken | partial "functions/gw2-api-get-account.dict" -}}
    {{- $matchData := slice $context $accountData.world | partial "functions/gw2-api-get-wvw-matches-by-world-id.dict" -}}

    {{- $mainWorldIds := slice -}}
    {{- $linkedWorldIds := slice -}}
    {{- range $color, $worldIds := $matchData.all_worlds -}}
        {{- if $accountData.world | in $worldIds -}}
            {{- $mainWorldId := $color | index $matchData.worlds -}}
            {{- $mainWorldIds = $mainWorldIds | append $mainWorldId -}}
            {{- range $worldIds -}}
                {{- if . | ne $mainWorldId -}}
                    {{- $linkedWorldIds = $linkedWorldIds | append . -}}
                {{- end -}}
            {{- end -}}
        {{- end -}}
    {{- end -}}

    {{- $worldIds := $mainWorldIds | append $linkedWorldIds -}}
    {{- $worldData := $worldIds | slice $context | partial "functions/gw2-api-get-worlds-by-world-ids.dict" -}}

    {{- range $worldData -}}
        {{- $worlds = $worlds | append .name -}}
    {{- end -}}
{{- else -}}
    {{- warnf "There is no GW2_ACCESS_TOKEN set, skipping ..." -}}
    {{- $worlds = $worlds | append "Unknown" -}}
{{- end -}}

{{- return $worlds -}}
