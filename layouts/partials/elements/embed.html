{{- $context := 0 | index . -}}
{{- $type := 1 | index . | lower -}}
{{- $inline := 2 | index . | default false -}}
{{- $data := 3 | index . | default dict -}}
{{- $class := 4 | index . | default slice -}}

{{- $data = $type | dict "type" | merge $data -}}
{{- $data = $inline | string | dict "inline" | merge $data -}}

{{- $classes := slice -}}
{{- $classes = $classes | append "gw2-embed" -}}
{{- with $inline -}}
    {{- $classes = $classes | append "is-inline" -}}
{{- end -}}
{{- with $type | printf "is-%s" -}}
    {{- $classes = $classes | append . -}}
{{- end -}}
{{- with $class -}}
    {{- $classes = $classes | append . -}}
{{- end -}}

{{- if $data.name -}}
    {{- $name := $data.name -}}

    {{- $slug := $name | slice $context $name | partial "functions/gw2-data-slugify.string" -}}

    {{- if $type | eq "effect" -}}
        {{- $data = $name | dict "id" | merge $data -}}
    {{- end -}}

    {{- if $type | eq "profession" -}}
        {{- $slugToId := slice $context | partialCached "functions/gw2-data-profession-slug-to-id.dict" -}}
        {{- $slugToElite := slice $context | partialCached "functions/gw2-data-profession-slug-to-elite.dict" -}}

        {{- $data = $slug | index $slugToId | dict "id" | merge $data -}}

        {{- with $slug | index $slugToElite -}}
            {{- $data = . | dict "elite" | merge $data -}}
        {{- end -}}
    {{- end -}}

    {{- if $type | eq "skill" -}}
        {{- $slugToId := slice $context | partialCached "functions/gw2-data-skill-slug-to-id.dict" -}}
        {{- $slugToName := slice $context | partialCached "functions/gw2-data-skill-slug-to-name.dict" -}}

        {{- $data = $slug | index $slugToId | dict "id" | merge $data -}}
        {{- $data = $slug | index $slugToName | dict "text" | merge $data -}}
    {{- end -}}

    {{- if $type | eq "specialization" -}}
        {{- $slugToId := slice $context | partialCached "functions/gw2-data-specialization-slug-to-id.dict" -}}

        {{- $data = $slug | index $slugToId | dict "id" | merge $data -}}
    {{- end -}}

    {{- if $type | eq "trait" -}}
        {{- $slugToId := slice $context | partialCached "functions/gw2-data-trait-slug-to-id.dict" -}}

        {{- $data = $slug | index $slugToId | dict "id" | merge $data -}}
    {{- end -}}

    {{- if not $data.text -}}
        {{- $data = dict "text" $name | merge $data -}}
    {{- end -}}

    {{- if "id" | index $data | not -}}
        {{- errorf "Unable to find %s name: %s" $type $name -}}
    {{- end -}}
{{- end -}}

{{- $attributes := dict -}}
{{- $attributes = delimit $classes " " | dict "class" | merge $attributes -}}
{{- range $key, $value := $data -}}
    {{- if "name" | ne $key -}}
        {{- $attribute := $key | printf "data-embed-%s" -}}
        {{- $attributes = $value | string | dict $attribute | merge $attributes -}}
    {{- end -}}
{{- end -}}

{{- if $inline -}}
    <span
        {{ range $key, $value := $attributes }}
            {{ $value | htmlEscape | printf "%s=%q" $key | safeHTMLAttr }}
        {{ end }}
    >
        {{- with "text" | index $data -}}
            <span class="gw2-embed-inline-placeholder"></span>{{- . -}}
        {{- else -}}
            &nbsp;
        {{- end -}}
    </span>
{{- else -}}
    <div
        {{ range $key, $value := $attributes }}
            {{ printf "%s=%q" $key $value | safeHTMLAttr }}
        {{ end }}
    >
    </div>
{{- end -}}
